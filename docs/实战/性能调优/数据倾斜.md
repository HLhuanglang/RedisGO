# 如何处理数据倾斜

## 现象

当集群架构中，个别数据分片的内存使用率、CPU使用率或带宽使用率等性能指标远远高于其他分片，那么该集群可能已经产生数据倾斜。 

严重时会导致整体集群在内存使用率不高的情况下出现内存逐出、内存溢出、响应时间上升等异常情况。

## 发生的原因与解决方案

当用户写入或更新数据时，客户端会通过CRC算法计算出Key所属的Slot，具体公式为Slot=CRC16(key)%16384，并将数据写入Slot所属的数据分片节点。通常情况下，各数据分片节点的Key数量是均匀分布的，同时内存使用率、CPU使用率等性能指标也是相近的。但在使用数据库的过程中，可能会由于前期规划不足、不规范的数据写入及突发的访问量，造成数据量倾斜或数据访问倾斜，最终引起数据倾斜。

![](https://hl1998-1255562705.cos.ap-shanghai.myqcloud.com/Img/20250206114354.png)

- Shard 1节点中key1的QPS明显高于其他Key，属于典型的数据访问倾斜，会导致该Key所在的数据分片节点CPU使用率、带宽使用率升高，从而影响该分片上所有Key的处理。
- Shard 2节点中key5的QPS虽然不高，但该Key的大小为1 MB，属于典型的数据量倾斜，会导致该Key所在的数据分片节点的内存使用率、带宽使用率升高，从而影响该分片上所有Key的处理。

| 倾斜场景      | 可能原因                   | 临时方案                                                     |
| ------------- | -------------------------- | ------------------------------------------------------------ |
| 内存倾斜      | 大Key、Hash Tags。         | 升级实例规格                                                 |
| 带宽倾斜      | 大Key、热Key、高消耗命令。 | 提升实例中指定1个或多个分片的带宽                            |
| CPU使用率倾斜 | 大Key、热Key、高消耗命令。 | - 如果热点Key分布在不同Slot，可以尝试在业务低峰期增加数据分片节点，使热点Key分散。<br />- 优化高消耗命令，例如减少每次**SCAN**命令获取Key的数量。 |



## 根源

| 产生倾斜原因 | 说明                                                         | 处理方案                                                     |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Hash Tag     | 若Key名称中包含`{}`，例如`{item}id1`，仅会对`{}`中的内容进行Slot计算并选择数据分片节点。若存在`{item}id1`、`{item}id2`、`{item}id3`等大量Key，由于`{}`中的内容相同，上述Key均会被分配至同一数据分片节点，导致该数据分片节点的内存资源、性能消耗大幅升高。 | 避免使用。【如果一定要是有，尽可能保证{}中的内容不一样，从而使key均匀分布在不同的机器上】 |
| 大key        | 大Key通常以Key的大小和Key中成员的数量来综合判定。常见于在KKV（Key-key-value）类型的数据结构中，例如Hash、List、Set、Zset等，存放过多或过大的field，从而导致单个Key过大，产生实例数据倾斜。 | 避免使用大key。例如hash类型则进行拆分                        |
| 热key        |                                                              |                                                              |
| 高消耗命令   |                                                              |                                                              |



